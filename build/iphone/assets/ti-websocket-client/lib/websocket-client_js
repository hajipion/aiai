var SHA1=require("sha1").SHA1,Utils=require("utils"),events=require("events"),debug=function(e){Ti.API.debug(e)},CONNECTING=0,OPEN=1,CLOSING=2,CLOSED=3,BUFFER_SIZE=65536,CLOSING_TIMEOUT=1e3,WebSocket=function(e,t,n,o){if(this.url=e,!this._parse_url())throw"Wrong url scheme for WebSocket: "+this.url;this.origin=n||String.format("http://%s:%s/",this._host,this._port),this.protocols=t,this.extensions=o,this.readyState=CONNECTING,this._masking_disabled=!1,this._headers=[],this._pong_received=!1,this._readBuffer="",this._socketReadBuffer=void 0,this._closingTimer=void 0,this._handshake=void 0,this._socket=void 0,this._fragmentSize=BUFFER_SIZE,this._connect()};exports.WebSocket=WebSocket,WebSocket.prototype=new events.EventEmitter,WebSocket.prototype.onopen=function(){},WebSocket.prototype.onmessage=function(){},WebSocket.prototype.onerror=function(){},WebSocket.prototype.onclose=function(){},WebSocket.prototype._parse_url=function(){var e=this.url.match(/^([a-z]+):\/\/([\w.]+)(:(\d+)|)(.*)/i);return e&&"ws"===e[1]?(this._host=e[2],this._port=e[4]||80,this._path=e[5],!0):!1};var make_handshake_key=function(){var e,t="";for(e=0;16>e;++e)t+=String.fromCharCode(255*Math.random()+1);return Utils.trim(Ti.Utils.base64encode(t))},make_handshake=function(e,t,n,o,r,i){return str="GET "+t+" HTTP/1.1\r\n",str+="Host: "+e+"\r\nUpgrade: websocket\r\nConnection: Upgrade\r\n",str+="Sec-WebSocket-Key: "+i+"\r\n",str+="Origin: "+n+"\r\n",str+="Sec-WebSocket-Origin: "+n+"\r\n",str+="Sec-WebSocket-Version: 7\r\n",o&&o.length>0&&(str+="Sec-WebSocket-Protocol: "+o.join(",")+"\r\n"),r&&r.length>0&&(str+="Sec-WebSocket-Extensions: "+r.join(",")+"\r\n"),str+"\r\n"};WebSocket.prototype._send_handshake=function(){this._handshake=make_handshake_key();var e=make_handshake(this._host,this._path,this.origin,this.protocols,this.extensions,this._handshake);return this._socket.write(Ti.createBuffer({value:e}))>0},WebSocket.prototype._read_http_headers=function(){for(var e="",t=Ti.createBuffer({length:BUFFER_SIZE}),n=10;;){var o=this._socket.read(t);if(o>0){var r=e.length;e+=Ti.Codec.decodeString({source:t,charset:Ti.Codec.CHARSET_ASCII});var i=e.match(/\r\n\r\n/);if(i){var s=i.index+4-r;e=e.substring(0,s-2),this.buffer=Ti.createBuffer({length:BUFFER_SIZE}),this.bufferSize=o-s,this.buffer.copy(t,0,s,this.bufferSize);break}}else if(debug("read_http_headers: timeout"),--n,0>n)return!1;t.clear()}return t.clear(),this.headers=e.split("\r\n"),!0};var extract_headers=function(e){var t={};return e.forEach(function(e){var n=e.indexOf(":");if(n>0){var o=Utils.trim(e.slice(0,n)),r=Utils.trim(e.slice(n+1));t[o]=r}}),t},handshake_reponse=function(e){return new SHA1(e+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").base64digest()};WebSocket.prototype._check_handshake_response=function(){var e=this.headers.shift();if("HTTP/1.1 101 Switching Protocols"!==e)return debug("mismatch protocol version"),!1;var t=extract_headers(this.headers);return t.Upgrade&&t.Connection&&t["Sec-WebSocket-Accept"]?"websocket"!==t.Upgrade.toLowerCase()||"upgrade"!==t.Connection.toLowerCase()||t["Sec-WebSocket-Accept"]!==handshake_reponse(this._handshake)?!1:(this.readyState=OPEN,!0):!1},WebSocket.prototype._create_frame=function(e,t,n){if(n===void 0&&(n=!0),n===!1&&e>=8&&15>=e)return!1;var o=t||"",r=Utils.byte_length(o),i=2,s=6;r>125&&BUFFER_SIZE>=r?i+=2:r>BUFFER_SIZE&&(i+=8),this._masking_disabled||(i+=4);var a=Ti.createBuffer({length:r+i+s}),c=0,u=e;if(n&&(u=128|u),Ti.Codec.encodeNumber({source:u,dest:a,position:c++,type:Ti.Codec.TYPE_BYTE}),125>=r){var l=r;this._masking_disabled||(l=128|l),Ti.Codec.encodeNumber({source:l,dest:a,position:c++,type:Ti.Codec.TYPE_BYTE})}else Ti.Codec.encodeNumber({source:255,dest:a,position:c++,type:Ti.Codec.TYPE_BYTE}),Ti.Codec.encodeNumber({source:r,dest:a,position:c,type:Ti.Codec.TYPE_LONG,byteOrder:Ti.Codec.BIG_ENDIAN}),c+=8;return c=this._mask_payload(a,c,o),a.length=c,a},WebSocket.prototype._mask_payload=function(e,t,n){if(!this._masking_disabled){var o,r=[];for(o=0;4>o;++o){var i=255&Math.floor(255*Math.random());r.push(i),Ti.Codec.encodeNumber({source:i,dest:e,position:t++,type:Ti.Codec.TYPE_BYTE})}var s=Ti.createBuffer({value:n}),a=Ti.Codec.decodeString({source:s,charset:Ti.Codec.CHARSET_ASCII}),c=s.length;for(c>e.length&&(e.length=c),o=0;c>o;++o)Ti.Codec.encodeNumber({source:a.charCodeAt(o)^r[o%4],dest:s,position:o,type:Ti.Codec.TYPE_BYTE});return e.copy(s,t,0,c),t+c}var u=Ti.Codec.encodeString({source:n,dest:e,destPosition:t});return u+t};var parse_frame=function(e,t){if(3>t)return void 0;var n=Utils.read_byte(e,0),o=!!(128&n),r=15&n,i=Utils.read_byte(e,1),s=127&i,a=2;switch(s){case 126:s=Utils.read_2byte(e,a),a+=2;break;case 127:s=Utils.read_8byte(e,a),a+=8}if(s+a>t)return void 0;var c=Ti.Codec.decodeString({source:e,position:a,length:s,charset:Ti.Codec.CHARSET_UTF8});return{fin:o,opcode:r,payload:c,size:s+a}};WebSocket.prototype.send=function(e){if(e&&this.readyState===OPEN){var t=Ti.createBuffer({value:e}),n=Ti.Codec.decodeString({source:t,charset:Ti.Codec.CHARSET_UTF8}),o=null,r=n.length;if(BUFFER_SIZE>r)return o=this._create_frame(1,n),this._socket.write(o)>0?!0:!1;for(var i=0,s=this._fragmentSize,a=null,c=!0,u=1,l=[];r>i&&!(i+s>r);)a=n.substring(i,s-i),u=128,c&&(u=1,c=!1),o=this._create_frame(u,a,!1),l.push(o),i+=s;for(a=n.substring(i,r),o=this._create_frame(1,a,!0),l.push(o);l.length>0;)if(o=l.shift(),1>this._socket.write(o))return!1;return!1}return!1},WebSocket.prototype._socket_close=function(){this._closingTimer&&clearTimeout(this._closingTimer),this._closingTimer=void 0,this._readBuffer="",this._socketReadBuffer=void 0;var e;this.readyState===CLOSING?(this.readyState=CLOSED,this._socket.close(),e={code:1e3,wasClean:!0,reason:""},this.emit("close",e),this.onclose(e)):this.readyState!==CLOSED&&(this._socket.close(),this.readyState=CLOSED,e={advice:"reconnect"},this.emit("error",e),this.onerror(e)),this._socket=void 0},WebSocket.prototype._read_buffer=function(e){var t=this,n=parse_frame(this.buffer,this.bufferSize);if(n===void 0)return e();if(n.size<this.bufferSize){var o=Ti.createBuffer({length:BUFFER_SIZE});this.bufferSize-n.size>0&&o.copy(this.buffer,0,n.size,this.bufferSize-n.size),this.buffer.clear(),this.buffer=o,this.bufferSize-=n.size}else this.buffer.clear(),this.bufferSize=0;switch(n.opcode){case 0:case 1:case 2:n.fin?(this.emit("message",{data:this._readBuffer+n.payload}),this.onmessage({data:this._readBuffer+n.payload}),this._readBuffer=""):this._readBuffer+=n.payload;break;case 8:this.readyState===CLOSING?this._socket_close():(this.readyState=CLOSING,this._socket.write(this._create_frame(8)),this._closingTimer=setTimeout(function(){t._socket_close()},CLOSING_TIMEOUT));break;case 9:this._socket.write(this._create_frame(10,n.payload));break;case 10:this._pong_received=!0}return e()},WebSocket.prototype._read_request=function(e,t){var n=e.bytesProcessed;return this.buffer===void 0?(this.buffer=this._socketReadBuffer.clone(),this.bufferSize=n):(this.buffer.copy(this._socketReadBuffer,this.bufferSize,0,n),this.bufferSize+=n,this.buffer.length+=n,this._socketReadBuffer.clear()),this._read_buffer(t)},WebSocket.prototype._read_callback=function(){var e=this,t=function(t){return t.bytesProcessed>0?e._read_request(t,function(){return setTimeout(n,0)}):setTimeout(n,100)},n=function(){if(e.bufferSize>0)return e._read_buffer(function(o){return o?setTimeout(n,0):(e._socketReadBuffer.clear(),Ti.Stream.read(e._socket,e._socketReadBuffer,t))});if(null!=e._socket)return e._socketReadBuffer.clear(),Ti.Stream.read(e._socket,e._socketReadBuffer,t)};return setTimeout(n,0)},WebSocket.prototype._error=function(e,t){if(this.buffer&&this.buffer.clear(),this.buffer=void 0,this.bufferSize=0,this.readyState=CLOSED,this._socket){try{this._socket.close()}catch(n){}this._socket=void 0}var o={wasClean:!0,code:e===void 0?1e3:e,advice:"reconnect",reason:t};this.emit("error",o),this.onerror(o)},WebSocket.prototype._raise_protocol_error=function(e){this._error(1002,e)},WebSocket.prototype.close=function(e,t){if(this.readyState===OPEN){this.readyState=CLOSING;var n=Ti.createBuffer({length:BUFFER_SIZE});if(Ti.Codec.encodeNumber({source:e||1e3,dest:n,position:0,type:Ti.Codec.TYPE_SHORT,byteOrder:Ti.Codec.BIG_ENDIAN}),t){var o=Ti.Codec.encodeString({source:t,dest:n,destPosition:2});n.length=2+o}else n.length=2;var r=Ti.Codec.decodeString({source:n,charset:Ti.Codec.CHARSET_ASCII});this._socket.write(this._create_frame(8,r));var i=this;this._closingTimer=setTimeout(function(){i._socket_close()},CLOSING_TIMEOUT)}},WebSocket.prototype._connect=function(){if(this.readyState===OPEN||this.readyState===CLOSING)return!1;var e=this;this._socket=Ti.Network.Socket.createTCP({host:this._host,port:this._port,mode:Ti.Network.READ_WRITE_MODE,connected:function(){var t;return(t=e._send_handshake())?(t=e._read_http_headers())?(t=e._check_handshake_response())?(e._readBuffer="",e._socketReadBuffer=Ti.createBuffer({length:BUFFER_SIZE}),e.readyState=OPEN,e.emit("open"),e.onopen(),e._read_callback(),void 0):e._raise_protocol_error("wrong handshake"):e._raise_protocol_error("parse http header"):e._raise_protocol_error("send handshake")},closed:function(){e._socket_close(),e.buffer&&e.buffer.clear(),e.buffer=void 0,e.bufferSize=0},error:function(t){var n;t!==void 0&&(n=t.error),e._error(1e3,n)}}),this._socket.connect()};