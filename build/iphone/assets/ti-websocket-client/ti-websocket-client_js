var SHA1=function(){var e={},t=function(){function e(e){e&=4294967295,0>e&&(e+=4294967296);var t=Number(e).toString(16);return 8>t.length&&(t="00000000".substr(0,8-t.length)+t),t}function t(e){var t=e+1+64;return 512*Math.ceil(t/512)/32}function n(e){var n,o=e.length,r=t(8*o),i=Array(r);for(n=0,j=0;o>n;)i[j++]=(255&e.charCodeAt(n++))<<24|(255&e.charCodeAt(n++))<<16|(255&e.charCodeAt(n++))<<8|255&e.charCodeAt(n++);for(;r>j;)i[j++]=0;return i}function o(e,t,n){if(n>4294967295){var o=4294967295&n;0>o&&(o+=4294967296),e[t-1]=o,e[t-2]=(n-o)/4294967296}else e[t-1]=n,e[t-2]=0;return e}function r(e,n){var r=Math.floor(n/32);return e[r]|=1<<32*(r+1)-n-1,o(e,t(n),n),e}function i(e){for(var t=0,n=0,o=[1732584193,4023233417,2562383102,271733878,3285377520];e.length>t;){var r=Array(80);for(n=0;16>n;n++)r[n]=e[t++];for(n=16;80>n;n++){var i=r[n-3]^r[n-8]^r[n-14]^r[n-16];r[n]=i<<1|i>>>31}var s=o[0],a=o[1],c=o[2],u=o[3],l=o[4];for(n=0;80>n;n++){var d=(s<<5|s>>>27)+l+r[n];n>=0&&19>=n?d+=(a&c|~a&u)+1518500249:n>=20&&39>=n?d+=(a^c^u)+1859775393:n>=40&&59>=n?d+=(a&c|a&u|c&u)+2400959708:n>=60&&79>=n&&(d+=(a^c^u)+3395469782),l=u,u=c,c=a<<30|a>>>2,a=s,s=d}o[0]=4294967295&o[0]+s,o[1]=4294967295&o[1]+a,o[2]=4294967295&o[2]+c,o[3]=4294967295&o[3]+u,o[4]=4294967295&o[4]+l,0>o[0]&&(o[0]+=4294967296),0>o[1]&&(o[1]+=4294967296),0>o[2]&&(o[2]+=4294967296),0>o[3]&&(o[3]+=4294967296),0>o[4]&&(o[4]+=4294967296)}return o}var s;s={enabled:!0,equals:function(e,t){var n;if(e instanceof Array&&t instanceof Array){if(e.length!==t.length)return!1;for(n=0;e.length>n;n++)if(!s.equals(e[n],t[n]))return!1;return!0}if(null!==e&&null!==t&&"object"==typeof e&&"object"==typeof t){for(n in e)if(e.hasOwnProperty(n)&&!s.equals(e[n],t[n]))return!1;return!0}return e===t},should:function(e,t){if(s.currentIndicator++,!e){var n=["[Spec failed",s.currentTitle?" ("+s.currentTitle+")] ":"] ",t||s.currentMessage+" "+s.currentIndicator||""].join("");throw alert(n),n}return!!e},describe:function(e,t){s.currentTitle=e;var n;for(n in t)t.hasOwnProperty(n)&&(s.currentMessage=n,s.currentIndicator=0,t[n](),s.currentIndicator=null);s.currentMessage=s.currentTitle=null},Version:"0.1"},s.should.equal=function(e,t,n){return s.should(s.equals(e,t),n)},s.should.not=function(e,t){return s.should(!e,t)},s.should.not.equal=function(e,t,n){return s.should(!s.equals(e,t),n)},s.enabled||(s.describe=function(){}),s.describe("Spec object",{should:function(){s.should(!0),s.should(1)},"should.not":function(){s.should.not(!1),s.should.not(0)},"should.equal":function(){s.should.equal(null,null),s.should.equal("",""),s.should.equal(12345,12345),s.should.equal([0,1,2],[0,1,2]),s.should.equal([0,1,[0,1,2]],[0,1,[0,1,2]]),s.should.equal({},{}),s.should.equal({x:1},{x:1}),s.should.equal({x:[1]},{x:[1]})},"should.not.equal":function(){s.should.not.equal([1,2,3],[1,2,3,4]),s.should.not.equal({x:1},[1,2,3,4])}}),s.describe("sha1",{strfhex32:function(){s.should.equal(e(0),"00000000"),s.should.equal(e(291),"00000123"),s.should.equal(e(4294967295),"ffffffff")}}),s.describe("sha1",{padding_size:function(){s.should.equal(t(0),16),s.should.equal(t(1),16),s.should.equal(t(447),16),s.should.equal(t(448),32)}}),s.describe("sha1",{word_array:function(){s.should.equal(n(""),[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),s.should.equal(n("1234")[0],825373492)}}),s.describe("sha1",{write_nbits:function(){s.should.equal(o([0,0],2,1),[0,1]),s.should.equal(o([0,0],2,4294967295),[0,4294967295]),s.should.equal(o([0,0],2,4294967296),[1,0]),s.should.equal(o([0,0],2,8589934591),[1,4294967295]),s.should.equal(o([0,0],2,1249835483136),[291,0]),s.should.equal(o([0,0],2,1252717883154),[291,2882400018])}});var a=function(e){this.message=e};return _base64_keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",a.prototype={digest:function(){var e=8*this.message.length,t=r(n(this.message),e);return i(t)},base64digest:function(){for(var e,t,n,o,r,i,s,a=this.hexdigest(),c="",u=0;a.length>u;)e=parseInt(a.substring(u,u+2),16),t=parseInt(a.substring(u+2,u+4),16),n=parseInt(a.substring(u+4,u+6),16),o=e>>2,r=(3&e)<<4|t>>4,i=(15&t)<<2|n>>6,s=63&n,isNaN(t)?i=s=64:isNaN(n)&&(s=64),c=c+_base64_keyStr.charAt(o)+_base64_keyStr.charAt(r)+_base64_keyStr.charAt(i)+_base64_keyStr.charAt(s),u+=6;return c},hexdigest:function(){var t,n=this.digest();for(t=0;n.length>t;t++)n[t]=e(n[t]);return n.join("")}},s.describe("sha1",{"SHA1#hexdigest":function(){s.should.equal(new a("").hexdigest(),"da39a3ee5e6b4b0d3255bfef95601890afd80709"),s.should.equal(new a("1").hexdigest(),"356a192b7913b04c54574d18c28d46e6395428ab"),s.should.equal(new a("Hello.").hexdigest(),"9b56d519ccd9e1e5b2a725e186184cdc68de0731"),s.should.equal(new a("9b56d519ccd9e1e5b2a725e186184cdc68de0731").hexdigest(),"f042dc98a62cbad68dbe21f11bbc1e9d416d2bf6"),s.should.equal(new a("MD5abZRVSXZVRcasdfasdddddddddddddddds+BNRJFSLKJFN+SEONBBJFJXLKCJFSE)RUNVXDLILKVJRN)#NVFJ)WVFWRW#)NVS$Q=$dddddddddddddWV;no9wurJFSE)RUNVXDLILKVJRN)#NVFJ)WVFWRW#)NVS$Q=$dddddddddddddWV;no9wurJFSE)RUNVXDLILKVJRN)#NVFJ)WVFWRW#)NVS$Q=$dddddddddddddWV;no9wurJFSE)RUNVXDLILKVJRN)#NVFJ)WVFWRW#)NVS$Q=$dddddddddddddWV;no9wuraddddddasdfasdfd").hexdigest(),"662dbf4ebc9cdb4224766e87634e5ba9e6de672b")}}),a}();return e.SHA1=t,e}().SHA1,Utils=function(){var e={};return e.read_byte=function(e,t){var n=Ti.Codec.decodeNumber({source:e,position:t||0,type:Ti.Codec.TYPE_BYTE,byteOrder:Ti.Codec.BIG_ENDIAN});return 0>n&&(n+=256),n},e.read_2byte=function(e,t){var n=Ti.Codec.decodeNumber({source:e,position:t||0,type:Ti.Codec.TYPE_SHORT,byteOrder:Ti.Codec.BIG_ENDIAN});return 0>n&&(n+=65536),n},e.read_8byte=function(e,t){var n=Ti.Codec.decodeNumber({source:e,position:t||0,type:Ti.Codec.TYPE_LONG,byteOrder:Ti.Codec.BIG_ENDIAN});return 0>n&&(n+=0x10000000000000000),n},e.byte_length=function(e){var t=Ti.createBuffer({length:65536}),n=Ti.Codec.encodeString({source:e,dest:t});return n},e.trim=function(e){return(e+"").replace(/^\s+|\s+$/g,"")},e}(),events=function(){function e(){}var t={},n=Array.isArray;t.EventEmitter=e;var o=10;return e.prototype.setMaxListeners=function(e){this._events||(this._events={}),this._maxListeners=e},e.prototype.emit=function(){var e=arguments[0];if(!this._events)return!1;var t=this._events[e];if(!t)return!1;var o,r,i;if("function"==typeof t){switch(arguments.length){case 1:t.call(this);break;case 2:t.call(this,arguments[1]);break;case 3:t.call(this,arguments[1],arguments[2]);break;default:for(r=arguments.length,o=Array(r-1),i=1;r>i;i++)o[i-1]=arguments[i];t.apply(this,o)}return!0}if(n(t)){for(r=arguments.length,o=Array(r-1),i=1;r>i;i++)o[i-1]=arguments[i];var s=t.slice();for(i=0,r=s.length;r>i;i++)s[i].apply(this,o);return!0}return!1},e.prototype.addListener=function(e,t){if("function"!=typeof t)throw Error("addListener only takes instances of Function");if(this._events||(this._events={}),this.emit("newListener",e,t),this._events[e])if(n(this._events[e])){if(this._events[e].push(t),!this._events[e].warned){var r;r=void 0!==this._maxListeners?this._maxListeners:o,r&&r>0&&this._events[e].length>r&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),console.trace())}}else this._events[e]=[this._events[e],t];else this._events[e]=t;return this},e.prototype.on=e.prototype.addListener,e.prototype.once=function(e,t){function n(){o.removeListener(e,n),t.apply(this,arguments)}if("function"!=typeof t)throw Error(".once only takes instances of Function");var o=this;return n.listener=t,o.on(e,n),this},e.prototype.removeListener=function(e,t){if("function"!=typeof t)throw Error("removeListener only takes instances of Function");if(!this._events||!this._events[e])return this;var o=this._events[e];if(n(o)){var r,i=-1;for(r=0,length=o.length;length>r;r++)if(o[r]===t||o[r].listener&&o[r].listener===t){i=r;break}if(0>i)return this;o.splice(i,1),0===o.length&&delete this._events[e]}else(o===t||o.listener&&o.listener===t)&&delete this._events[e];return this},e.prototype.removeAllListeners=function(e){return 0===arguments.length?(this._events={},this):(e&&this._events&&this._events[e]&&(this._events[e]=null),this)},e.prototype.listeners=function(e){return this._events||(this._events={}),this._events[e]||(this._events[e]=[]),n(this._events[e])||(this._events[e]=[this._events[e]]),this._events[e]},t}(),debug=function(e){Ti.API.debug(e)},CONNECTING=0,OPEN=1,CLOSING=2,CLOSED=3,BUFFER_SIZE=65536,CLOSING_TIMEOUT=1e3,WebSocket=function(e,t,n,o){if(this.url=e,!this._parse_url())throw"Wrong url scheme for WebSocket: "+this.url;this.origin=n||String.format("http://%s:%s/",this._host,this._port),this.protocols=t,this.extensions=o,this.readyState=CONNECTING,this._masking_disabled=!1,this._headers=[],this._pong_received=!1,this._readBuffer="",this._socketReadBuffer=void 0,this._closingTimer=void 0,this._handshake=void 0,this._socket=void 0,this._fragmentSize=BUFFER_SIZE,this._connect()};exports.WebSocket=WebSocket,WebSocket.prototype=new events.EventEmitter,WebSocket.prototype.onopen=function(){},WebSocket.prototype.onmessage=function(){},WebSocket.prototype.onerror=function(){},WebSocket.prototype.onclose=function(){},WebSocket.prototype._parse_url=function(){var e=this.url.match(/^([a-z]+):\/\/([\w.]+)(:(\d+)|)(.*)/i);return e&&"ws"===e[1]?(this._host=e[2],this._port=e[4]||80,this._path=e[5],!0):!1};var make_handshake_key=function(){var e,t="";for(e=0;16>e;++e)t+=String.fromCharCode(255*Math.random()+1);return Utils.trim(Ti.Utils.base64encode(t))},make_handshake=function(e,t,n,o,r,i){return str="GET "+t+" HTTP/1.1\r\n",str+="Host: "+e+"\r\nUpgrade: websocket\r\nConnection: Upgrade\r\n",str+="Sec-WebSocket-Key: "+i+"\r\n",str+="Origin: "+n+"\r\n",str+="Sec-WebSocket-Origin: "+n+"\r\n",str+="Sec-WebSocket-Version: 7\r\n",o&&o.length>0&&(str+="Sec-WebSocket-Protocol: "+o.join(",")+"\r\n"),r&&r.length>0&&(str+="Sec-WebSocket-Extensions: "+r.join(",")+"\r\n"),str+"\r\n"};WebSocket.prototype._send_handshake=function(){this._handshake=make_handshake_key();var e=make_handshake(this._host,this._path,this.origin,this.protocols,this.extensions,this._handshake);return this._socket.write(Ti.createBuffer({value:e}))>0},WebSocket.prototype._read_http_headers=function(){for(var e="",t=Ti.createBuffer({length:BUFFER_SIZE}),n=10;;){var o=this._socket.read(t);if(o>0){var r=e.length;e+=Ti.Codec.decodeString({source:t,charset:Ti.Codec.CHARSET_ASCII});var i=e.match(/\r\n\r\n/);if(i){var s=i.index+4-r;e=e.substring(0,s-2),this.buffer=Ti.createBuffer({length:BUFFER_SIZE}),this.bufferSize=o-s,this.buffer.copy(t,0,s,this.bufferSize);break}}else if(debug("read_http_headers: timeout"),--n,0>n)return!1;t.clear()}return t.clear(),this.headers=e.split("\r\n"),!0};var extract_headers=function(e){var t={};return e.forEach(function(e){var n=e.indexOf(":");if(n>0){var o=Utils.trim(e.slice(0,n)),r=Utils.trim(e.slice(n+1));t[o]=r}}),t},handshake_reponse=function(e){return new SHA1(e+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").base64digest()};WebSocket.prototype._check_handshake_response=function(){var e=this.headers.shift();if("HTTP/1.1 101 Switching Protocols"!==e)return debug("mismatch protocol version"),!1;var t=extract_headers(this.headers);return t.Upgrade&&t.Connection&&t["Sec-WebSocket-Accept"]?"websocket"!==t.Upgrade.toLowerCase()||"upgrade"!==t.Connection.toLowerCase()||t["Sec-WebSocket-Accept"]!==handshake_reponse(this._handshake)?!1:(this.readyState=OPEN,!0):!1},WebSocket.prototype._create_frame=function(e,t,n){if(n===void 0&&(n=!0),n===!1&&e>=8&&15>=e)return!1;var o=t||"",r=Utils.byte_length(o),i=2,s=6;r>125&&BUFFER_SIZE>=r?i+=2:r>BUFFER_SIZE&&(i+=8),this._masking_disabled||(i+=4);var a=Ti.createBuffer({length:r+i+s}),c=0,u=e;if(n&&(u=128|u),Ti.Codec.encodeNumber({source:u,dest:a,position:c++,type:Ti.Codec.TYPE_BYTE}),125>=r){var l=r;this._masking_disabled||(l=128|l),Ti.Codec.encodeNumber({source:l,dest:a,position:c++,type:Ti.Codec.TYPE_BYTE})}else Ti.Codec.encodeNumber({source:255,dest:a,position:c++,type:Ti.Codec.TYPE_BYTE}),Ti.Codec.encodeNumber({source:r,dest:a,position:c,type:Ti.Codec.TYPE_LONG,byteOrder:Ti.Codec.BIG_ENDIAN}),c+=8;return c=this._mask_payload(a,c,o),a.length=c,a},WebSocket.prototype._mask_payload=function(e,t,n){if(!this._masking_disabled){var o,r=[];for(o=0;4>o;++o){var i=255&Math.floor(255*Math.random());r.push(i),Ti.Codec.encodeNumber({source:i,dest:e,position:t++,type:Ti.Codec.TYPE_BYTE})}var s=Ti.createBuffer({value:n}),a=Ti.Codec.decodeString({source:s,charset:Ti.Codec.CHARSET_ASCII}),c=s.length;for(c>e.length&&(e.length=c),o=0;c>o;++o)Ti.Codec.encodeNumber({source:a.charCodeAt(o)^r[o%4],dest:s,position:o,type:Ti.Codec.TYPE_BYTE});return e.copy(s,t,0,c),t+c}var u=Ti.Codec.encodeString({source:n,dest:e,destPosition:t});return u+t};var parse_frame=function(e,t){if(3>t)return void 0;var n=Utils.read_byte(e,0),o=!!(128&n),r=15&n,i=Utils.read_byte(e,1),s=127&i,a=2;switch(s){case 126:s=Utils.read_2byte(e,a),a+=2;break;case 127:s=Utils.read_8byte(e,a),a+=8}if(s+a>t)return void 0;var c=Ti.Codec.decodeString({source:e,position:a,length:s,charset:Ti.Codec.CHARSET_UTF8});return{fin:o,opcode:r,payload:c,size:s+a}};WebSocket.prototype.send=function(e){if(e&&this.readyState===OPEN){var t=Ti.createBuffer({value:e}),n=Ti.Codec.decodeString({source:t,charset:Ti.Codec.CHARSET_UTF8}),o=null,r=n.length;if(BUFFER_SIZE>r)return o=this._create_frame(1,n),this._socket.write(o)>0?!0:!1;for(var i=0,s=this._fragmentSize,a=null,c=!0,u=1,l=[];r>i&&!(i+s>r);)a=n.substring(i,s-i),u=128,c&&(u=1,c=!1),o=this._create_frame(u,a,!1),l.push(o),i+=s;for(a=n.substring(i,r),o=this._create_frame(1,a,!0),l.push(o);l.length>0;)if(o=l.shift(),1>this._socket.write(o))return!1;return!1}return!1},WebSocket.prototype._socket_close=function(){this._closingTimer&&clearTimeout(this._closingTimer),this._closingTimer=void 0,this._readBuffer="",this._socketReadBuffer=void 0;var e;this.readyState===CLOSING?(this.readyState=CLOSED,this._socket.close(),e={code:1e3,wasClean:!0,reason:""},this.emit("close",e),this.onclose(e)):this.readyState!==CLOSED&&(this._socket.close(),this.readyState=CLOSED,e={advice:"reconnect"},this.emit("error",e),this.onerror(e)),this._socket=void 0},WebSocket.prototype._read_buffer=function(e){var t=this,n=parse_frame(this.buffer,this.bufferSize);if(n===void 0)return e();if(n.size<this.bufferSize){var o=Ti.createBuffer({length:BUFFER_SIZE});this.bufferSize-n.size>0&&o.copy(this.buffer,0,n.size,this.bufferSize-n.size),this.buffer.clear(),this.buffer=o,this.bufferSize-=n.size}else this.buffer.clear(),this.bufferSize=0;switch(n.opcode){case 0:case 1:case 2:n.fin?(this.emit("message",{data:this._readBuffer+n.payload}),this.onmessage({data:this._readBuffer+n.payload}),this._readBuffer=""):this._readBuffer+=n.payload;break;case 8:this.readyState===CLOSING?this._socket_close():(this.readyState=CLOSING,this._socket.write(this._create_frame(8)),this._closingTimer=setTimeout(function(){t._socket_close()},CLOSING_TIMEOUT));break;case 9:this._socket.write(this._create_frame(10,n.payload));break;case 10:this._pong_received=!0}return e()},WebSocket.prototype._read_request=function(e,t){var n=e.bytesProcessed;return this.buffer===void 0?(this.buffer=this._socketReadBuffer.clone(),this.bufferSize=n):(this.buffer.copy(this._socketReadBuffer,this.bufferSize,0,n),this.bufferSize+=n,this.buffer.length+=n,this._socketReadBuffer.clear()),this._read_buffer(t)},WebSocket.prototype._read_callback=function(){var e=this,t=function(t){return t.bytesProcessed>0?e._read_request(t,function(){return setTimeout(n,0)}):setTimeout(n,100)},n=function(){if(e.bufferSize>0)return e._read_buffer(function(o){return o?setTimeout(n,0):(e._socketReadBuffer.clear(),Ti.Stream.read(e._socket,e._socketReadBuffer,t))});if(null!=e._socket)return e._socketReadBuffer.clear(),Ti.Stream.read(e._socket,e._socketReadBuffer,t)};return setTimeout(n,0)},WebSocket.prototype._error=function(e,t){if(this.buffer&&this.buffer.clear(),this.buffer=void 0,this.bufferSize=0,this.readyState=CLOSED,this._socket){try{this._socket.close()}catch(n){}this._socket=void 0}var o={wasClean:!0,code:e===void 0?1e3:e,advice:"reconnect",reason:t};this.emit("error",o),this.onerror(o)},WebSocket.prototype._raise_protocol_error=function(e){this._error(1002,e)},WebSocket.prototype.close=function(e,t){if(this.readyState===OPEN){this.readyState=CLOSING;var n=Ti.createBuffer({length:BUFFER_SIZE});if(Ti.Codec.encodeNumber({source:e||1e3,dest:n,position:0,type:Ti.Codec.TYPE_SHORT,byteOrder:Ti.Codec.BIG_ENDIAN}),t){var o=Ti.Codec.encodeString({source:t,dest:n,destPosition:2});n.length=2+o}else n.length=2;var r=Ti.Codec.decodeString({source:n,charset:Ti.Codec.CHARSET_ASCII});this._socket.write(this._create_frame(8,r));var i=this;this._closingTimer=setTimeout(function(){i._socket_close()},CLOSING_TIMEOUT)}},WebSocket.prototype._connect=function(){if(this.readyState===OPEN||this.readyState===CLOSING)return!1;var e=this;this._socket=Ti.Network.Socket.createTCP({host:this._host,port:this._port,mode:Ti.Network.READ_WRITE_MODE,connected:function(){var t;return(t=e._send_handshake())?(t=e._read_http_headers())?(t=e._check_handshake_response())?(e._readBuffer="",e._socketReadBuffer=Ti.createBuffer({length:BUFFER_SIZE}),e.readyState=OPEN,e.emit("open"),e.onopen(),e._read_callback(),void 0):e._raise_protocol_error("wrong handshake"):e._raise_protocol_error("parse http header"):e._raise_protocol_error("send handshake")},closed:function(){e._socket_close(),e.buffer&&e.buffer.clear(),e.buffer=void 0,e.bufferSize=0},error:function(t){var n;t!==void 0&&(n=t.error),e._error(1e3,n)}}),this._socket.connect()};