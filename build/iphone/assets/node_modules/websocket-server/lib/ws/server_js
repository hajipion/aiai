function reflectEvent(e,t,r,o){e.addListener(t,function(){r.emit.apply(r,[o||t].concat(Array.prototype.slice.call(arguments)))})}function reflectMethod(e,t,r,o){r[o||t]=function(){return e[t].apply(e,arguments)}}function clientWrite(e,t){e&&4===e._state&&e.write(t)}function Server(e){events.EventEmitter.call(this);var t=Mixin({debug:!1,server:new http.Server},e),r=new Manager(t),o=t.server;if(t.datastore)throw Error("Built-in DataStore has been removed, see: http://github.com/miksago/nws-memstore");o.on("upgrade",function(e,o,i){"GET"==e.method&&e.headers.upgrade&&e.headers.connection&&"websocket"==e.headers.upgrade.toLowerCase()&&"upgrade"==e.headers.connection.toLowerCase()&&new Connection(r,t,e,o,i)}),r.bubbleEvent("error",this),reflectEvent(r,"attach",this,"connection"),reflectEvent(r,"detach",this,"disconnect"),reflectEvent(o,"listening",this),reflectEvent(o,"request",this),reflectEvent(o,"stream",this),reflectEvent(o,"close",this),reflectEvent(o,"clientError",this),reflectEvent(o,"error",this),reflectMethod(o,"listen",this),reflectMethod(o,"close",this),this.send=function(e,t){r.find(e,function(e){clientWrite(e,t)})},this.broadcast=function(e){r.forEach(function(t){clientWrite(t,e)})},this.server=o,this.manager=r,this.options=t}var http=require("http"),path=require("path"),util=require("../_util"),events=require("../_events"),Manager=require("./manager"),Connection=require("./connection"),Mixin=require("../lang/mixin");exports.Server=Server,exports.createServer=function(e){return new Server(e)},util.inherits(Server,events.EventEmitter);