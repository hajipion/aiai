function Connection(e,t,r,o,i){var n,a=this;if(_events.EventEmitter.call(this),this._req=r,this._socket=o,this._manager=e,this.id=e.createId(o.remotePort),this._options=Mixin({version:"auto",origin:"*",subprotocol:"*",debug:!0},t),a._options.debug&&(debug=function(){util.error("[90mWS: "+Array.prototype.join.call(arguments," ")+"[39m"),process.stdout.flush()}),Object.defineProperties(this,{version:{get:function(){return r.headers["sec-websocket-key1"]&&r.headers["sec-websocket-key2"]?"draft76":"draft75"}}}),a._closeTimer=void 0,a.state(1),a.on("stateChange",function(t,r){a._options.debug&&debug(a.id,"stateChange: ",r,"->",t),4===t?(e.attach(a),n&&(s.write(n),delete n)):5===t&&6!==r&&5!==r?close(a):6===t&&5===r&&(e.detach(a),a.emit("close"))}),checkVersion(this)){debug(this.id,this.version+" connection"),o.setTimeout(0),o.setNoDelay(!0),o.setKeepAlive(!0,0);var s=new Parser(this);switch(s.on("message",function(e){debug(a.id,"recv: "+e),a.emit("message",e)}),s.on("close",function(){debug(a.id,"requested close"),a._closeTimer&&clearTimeout(a._closeTimer),a.state(5)}),o.on("data",function(e){s.write(e)}),o.on("end",function(){debug(a.id,"end"),a.state(5)}),o.on("timeout",function(){debug(a.id,"timed out"),a.emit("timeout")}),o.on("error",function(e){debug(a.id,"error",e),(e.errno!=Constants.EPIPE||e.errno!=a.ECONNRESET)&&a.emit("error",e),a.state(5)}),a.bubbleEvent("error",e),this.version){case"draft76":i.length>=8?(i.length>8&&(n=i.slice(8,i.length)),handshakes.draft76(a,i.slice(0,8))):a.reject("Missing key3");break;case"draft75":handshakes.draft75(a);break;default:a.reject("Unknown version: "+this.version)}}else this.reject("Invalid version.")}function write(e,t){return debug(e.id,"write: ",t.inspect()),e._socket.writable?e._socket.write(t):!1}function close(e){e._socket.end(),e._socket.destroy(),debug(e.id,"socket closed"),e.state(6)}function checkVersion(e){var t=e._options.version.toLowerCase();return"auto"==t||t==e.version}function pack(e){var t="";return t+=String.fromCharCode(255&e>>24),t+=String.fromCharCode(255&e>>16),t+=String.fromCharCode(255&e>>8),t+=String.fromCharCode(255&e)}function websocket_origin(e){var t=e._options.origin||"*";return("*"==t||Array.isArray(t))&&(t=e._req.headers.origin),t}function websocket_location(e){if(void 0===e._req.headers.host)return e.reject("Missing host header"),void 0;var t="",r=e._socket.secure,o=e._req.headers.host.split(":"),i=void 0!==o[1]?o[1]:r?443:80;return t+=r?"wss://":"ws://",t+=o[0],(!r&&80!=i||r&&443!=i)&&(t+=":"+i),t+=e._req.url}function Parser(){events.EventEmitter.call(this),this.frameData=[],this.order=0,this.closing=!1}var debug=function(){},util=require("../_util"),events=require("events"),Url=require("url"),Buffer=require("buffer").Buffer,Crypto=require("crypto"),Constants=require("constants"),_events=require("../_events"),Mixin=require("../lang/mixin"),CLOSE_FRAME=new Buffer(2);CLOSE_FRAME[0]=255,CLOSE_FRAME[1]=0,module.exports=Connection,util.inherits(Connection,_events.EventEmitter),Connection.prototype._state=0,Connection.prototype.state=function(e){if(void 0!==e&&"number"==typeof e){var t=this._state;this._state=e,this.emit("stateChange",this._state,t)}},Connection.prototype.inspect=function(){return"<WS:Connection "+this.id+">"},Connection.prototype.write=function(e){if(4===this._state){var t=Buffer.byteLength(e,"utf8"),r=new Buffer(t+2);return r[0]=0,r.write(e,1,"utf8"),r[t+1]=255,write(this,r)}return debug(this.id,"[31mCould not send."),!1},Connection.prototype.send=Connection.prototype.write,Connection.prototype.broadcast=function(e){this._manager.forEach(function(t){t&&4===t._state&&t.id!=this.id&&t.write(e)},this)},Connection.prototype.close=function(){var e=this;4==e._state&&e._socket.writable&&write(e,CLOSE_FRAME),e._closeTimer=setTimeout(function(){e.state(5)},15e3)},Connection.prototype.reject=function(e){debug(this.id,"rejected. Reason: "+e),this.state(5)},Connection.prototype.handshake=function(){3>this._state?(debug(this.id,this.version+" handshake"),this.state(3),doHandshake[this.version].call(this)):debug(this.id,"Already handshaked.")};var handshakes={draft75:function(e){e.state(3);var t,r=websocket_location(e);r&&(t="HTTP/1.1 101 Web Socket Protocol Handshake\r\nUpgrade: WebSocket\r\nConnection: Upgrade\r\nWebSocket-Origin: "+websocket_origin(e)+"\r\n"+"WebSocket-Location: "+r,e._options.subprotocol&&"string"==typeof e._options.subprotocol&&(t+="\r\nWebSocket-Protocol: "+e._options.subprotocol),e._socket.write(t+"\r\n\r\n","ascii"),e.state(4))},draft76:function(e,t){e.state(3);var r,o=websocket_location(e);if(o){r="HTTP/1.1 101 WebSocket Protocol Handshake\r\nUpgrade: WebSocket\r\nConnection: Upgrade\r\nSec-WebSocket-Origin: "+websocket_origin(e)+"\r\n"+"Sec-WebSocket-Location: "+o,e._options.subprotocol&&"string"==typeof e._options.subprotocol&&(r+="\r\nSec-WebSocket-Protocol: "+e._options.subprotocol);var i=e._req.headers["sec-websocket-key1"],n=e._req.headers["sec-websocket-key2"],a=parseInt(i.replace(/[^\d]/g,""),10),s=parseInt(n.replace(/[^\d]/g,""),10),u=i.replace(/[^\ ]/g,"").length,l=n.replace(/[^\ ]/g,"").length;if(0==u||0==l||0!=a%u||0!=s%l)e.reject("WebSocket Handshake contained an invalid key");else{var c=Crypto.createHash("md5"),S=pack(parseInt(a/u)),d=pack(parseInt(s/l));c.update(S),c.update(d),c.update(t.toString("binary")),r+="\r\n\r\n",r+=c.digest("binary"),e._socket.write(r,"binary"),e.state(4)}}}};util.inherits(Parser,events.EventEmitter),Parser.prototype.write=function(e){var t;debug("parse.write",e.inspect());for(var r=0,o=e.length;o>r;r++)0==this.order&&(this.order=true&e[r]?1:-1),-1==this.order?255===e[r]?(t=new Buffer(this.frameData),this.order=0,this.frameData=[],this.emit("message",t.toString("utf8",0,t.length))):0!==e[r]&&this.frameData.push(e[r]):1==this.order&&(this.closing&&0===e[r]?(this.emit("close"),this.closing=!1):255===e[r]&&0==this.frameData.length?this.closing=!0:(debug("High Order packet handling is not yet implemented."),this.order=0,this.closing=!1))};