assert=require("assert");var path=require("path");net=require("net"),http=require("http"),url=require("url"),qs=require("querystring");var fs=require("fs"),sys=require("sys"),have_openssl;try{var crypto=require("crypto"),dummy_server=http.createServer(function(){});dummy_server.setSecure(),have_openssl=!0}catch(e){have_openssl=!1,console.log("Not compiled with OPENSSL support."),process.exit()}var request_number=0,requests_sent=0,server_response="",client_got_eof=!1,caPem=fs.readFileSync(path.normalize(path.join(__dirname,"test_ca.pem")),"ascii"),certPem=fs.readFileSync(path.normalize(path.join(__dirname,"test_cert.pem")),"ascii"),keyPem=fs.readFileSync(path.normalize(path.join(__dirname,"test_key.pem")),"ascii"),credentials=crypto.createCredentials({key:keyPem,cert:certPem,ca:caPem}),https_server=http.createServer(function(e,t){request_number++,t.writeHead(204,{"Content-Type":"text/plain"}),t.end()});https_server.on("upgrade",function(e,t){console.log("upgrade!"),request_number++,t.write("hello"),t.on("data",function(e){console.log("server recv",e),t.write("die")}),t.on("end",function(){t.end(),t.destroy()})}),https_server.setSecure(credentials),https_server.listen(123456),https_server.addListener("listening",function(){var e=net.createConnection(123456);e.setEncoding("utf8"),e.addListener("connect",function(){console.log("c.connect"),e.setSecure(credentials)}),e.addListener("secure",function(){e.write("GET / HTTP/1.1\r\n\r\n"),requests_sent++,e.write("GET / HTTP/1.1\r\nUpgrade: WebSocket\r\nConnection: Upgrade\r\n\r\n"),requests_sent++}),e.addListener("data",function(t){console.log("<< c: '",t,"'"),"hello"!=t?e.end():(e.write(t),console.log(">> c:",t))}),e.addListener("end",function(){console.log("c.end"),e.destroy()}),e.addListener("close",function(){console.log("c.close"),console.dir(https_server),https_server.close()})}),process.addListener("exit",function(){assert.equal(2,request_number),assert.equal(2,requests_sent)});