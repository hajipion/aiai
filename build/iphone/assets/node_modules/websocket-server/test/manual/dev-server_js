function pad(e){return 10>e?"0"+e.toString(10):e.toString(10)}function timestamp(){var e=new Date;return[e.getDate(),months[e.getMonth()],[pad(e.getHours()),pad(e.getMinutes()),pad(e.getSeconds()),(e.getTime()+"").substr(-4,4)].join(":")].join(" ")}function log(e){sys.puts(timestamp()+" - "+(""+e))}function readPage(e,t){cache[e]?t(cache[e]):(cache[e]=[],fs.createReadStream(Path.normalize(Path.join(__dirname,e)),{flags:"r",encoding:"binary",mode:438,bufferSize:4096}).addListener("data",function(t){cache[e].push(t)}).on("end",function(){t(cache[e])}))}function serveFile(e,t){"GET"==e.method?e.url.indexOf("favicon")>-1?(log("HTTP: inbound request, served nothing, (favicon)"),t.writeHead(200,{"Content-Type":"image/x-icon"}),t.end("")):(log("HTTP: inbound request, served client.html"),t.writeHead(200,{"Content-Type":"text/html",Connection:"close"}),readPage("client.html",function(e){e.forEach(function(e){t.write(e)}),t.end()})):(t.writeHead(200,{"Content-Type":"text/html"}),t.end())}var sys=require("sys"),fs=require("fs"),Path=require("path"),http=require("http"),crypto=require("crypto"),ws=require("../lib/ws/server");console.log(process.pid);var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],cache={};readPage("client.html",function(){});var reqnum=0,certPem=fs.readFileSync(Path.normalize(Path.join(__dirname,"ssl/cert.pem")),"ascii"),keyPem=fs.readFileSync(Path.normalize(Path.join(__dirname,"ssl/cert.key")),"ascii"),credentials=crypto.createCredentials({key:keyPem,cert:certPem}),httpServer=http.createServer(serveFile),server=ws.createServer({debug:!0,useStorage:!0,server:httpServer});server.setSecure(credentials),server.addListener("listening",function(){log("Listening for connections.")}),server.addListener("connection",function(e){e.send("Connection: "+e.id),e.broadcast("<"+e.id+"> connected"),e.addListener("message",function(t){e.broadcast("<"+e.id+"> "+t)})}),server.addListener("close",function(e){server.broadcast("<"+e.id+"> disconnected")}),server.listen(8e3);