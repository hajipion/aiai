var sys=require("sys"),http=require("http"),fs=require("fs"),path=require("path"),ws=require("../../lib/ws/server"),httpServer=http.createServer(function(e,t){"GET"==e.method?e.url.indexOf("favicon")>-1?(t.writeHead(200,{"Content-Type":"image/x-icon",Connection:"close"}),t.end("")):(t.writeHead(200,{"Content-Type":"text/html",Connection:"close"}),fs.createReadStream(path.normalize(path.join(__dirname,"client.html")),{flags:"r",encoding:"binary",mode:438,bufferSize:4096}).addListener("data",function(e){t.write(e,"binary")}).addListener("end",function(){t.end()})):(t.writeHead(404),t.end())}),server=ws.createServer({server:httpServer});server.addListener("listening",function(){sys.log("Listening for connections.")}),server.addListener("connection",function(e){console.log("[*] open"),e.send("** Connected as: user_"+e.id),e.send("** Type `/nick USERNAME` to change your username"),e.send("bar Î” test foo bar"),e.broadcast("** "+e.id+" connected"),e.addListener("message",function(t){"close"==t?(console.log("[-] close requested"),e.close()):(console.log("[+] ",new Buffer(t).inspect()),server.broadcast(e.id+": "+t))}),e.addListener("close",function(){console.log("[*] close")})}),server.addListener("disconnect",function(e){server.broadcast("<"+e.id+"> disconnected")}),server.listen(8e3);