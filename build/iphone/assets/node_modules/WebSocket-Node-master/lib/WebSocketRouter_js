function WebSocketRouter(e){this.config={server:null},e&&extend(this.config,e),this.config.server&&this.attachServer(this.config.server),this.handlers=[],this._requestHandler=this.handleRequest.bind(this)}var extend=require("./utils").extend,util=require("util"),EventEmitter=require("events").EventEmitter,WebSocketRouterRequest=require("./WebSocketRouterRequest");util.inherits(WebSocketRouter,EventEmitter),WebSocketRouter.prototype.attachServer=function(e){if(!e)throw Error("You must specify a WebSocketServer instance to attach to.");this.server=e,this.server.on("request",this._requestHandler)},WebSocketRouter.prototype.detachServer=function(){if(!this.server)throw Error("Cannot detach from server: not attached.");this.server.removeListener("request",this._requestHandler),this.server=null},WebSocketRouter.prototype.mount=function(e,t,o){if(!e)throw Error("You must specify a path for this handler.");if(t||(t="____no_protocol____"),!o)throw Error("You must specify a callback for this handler.");if(e=this.pathToRegExp(e),!(e instanceof RegExp))throw Error("Path must be specified as either a string or a RegExp.");var i=""+e;if(t=t.toLocaleLowerCase(),-1!==this.findHandlerIndex(i,t))throw Error("You may only mount one handler per path/protocol combination.");this.handlers.push({path:e,pathString:i,protocol:t,callback:o})},WebSocketRouter.prototype.unmount=function(e,t){var o=this.findHandlerIndex(""+this.pathToRegExp(e),t);if(-1===o)throw Error("Unable to find a route matching the specified path and protocol.");this.handlers.splice(o,1)},WebSocketRouter.prototype.findHandlerIndex=function(e,t){t=t.toLocaleLowerCase();for(var o=0,i=this.handlers.length;i>o;o++){var r=this.handlers[o];if(r.pathString===e&&r.protocol===t)return o}return-1},WebSocketRouter.prototype.pathToRegExp=function(e){return"string"==typeof e&&("*"===e?e=/^.*$/:(e=e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),e=RegExp("^"+e+"$"))),e},WebSocketRouter.prototype.handleRequest=function(e){var t=e.requestedProtocols;0===t.length&&(t=["____no_protocol____"]);for(var o=0;t.length>o;o++)for(var i=t[o].toLocaleLowerCase(),r=0,s=this.handlers.length;s>r;r++){var n=this.handlers[r];if(n.path.test(e.resourceURL.pathname)&&(i===n.protocol||"*"===n.protocol)){var a=new WebSocketRouterRequest(e,i);return n.callback(a),void 0}}e.reject(404,"No handler is available for the given request.")},module.exports=WebSocketRouter;