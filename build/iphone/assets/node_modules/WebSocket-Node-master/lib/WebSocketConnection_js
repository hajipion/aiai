function WebSocketConnection(e,t,o,i,n){if(this.config=n,this.socket=e,this.protocol=o,this.extensions=t,this.remoteAddress=e.remoteAddress,this.closeReasonCode=-1,this.closeDescription=null,this.maskOutgoingPackets=i,this.maskBytes=new Buffer(4),this.frameHeader=new Buffer(10),this.bufferList=new BufferList,this.currentFrame=new WebSocketFrame(this.maskBytes,this.frameHeader,this.config),this.fragmentationSize=0,this.frameQueue=[],this.connected=!0,this.state=STATE_OPEN,this.waitingForCloseResponse=!1,this.closeTimeout=this.config.closeTimeout,this.assembleFragments=this.config.assembleFragments,this.maxReceivedMessageSize=this.config.maxReceivedMessageSize,this.socket.removeAllListeners("error"),this.socket.on("error",this.handleSocketError.bind(this)),this.socket.on("data",this.handleSocketData.bind(this)),this.socket.on("end",this.handleSocketEnd.bind(this)),this.socket.on("close",this.handleSocketClose.bind(this)),this.socket.on("drain",this.handleSocketDrain.bind(this)),this.socket.setNoDelay(this.config.disableNagleAlgorithm),this.socket.setTimeout(0),this.outgoingFrameQueue=[],this.outputPaused=!1,this.outgoingFrameQueueHandler=this.processOutgoingFrameQueue.bind(this),this.bytesWaitingToFlush=0,this._closeTimerHandler=this.handleCloseTimer.bind(this),this.config.keepalive&&!this.config.useNativeKeepalive){if("number"!=typeof this.config.keepaliveInterval)throw Error("keepaliveInterval must be specified and numeric if keepalive is true.");if(this._keepaliveTimerHandler=this.handleKeepaliveTimer.bind(this),this.setKeepaliveTimer(),this.config.dropConnectionOnKeepaliveTimeout){if("number"!=typeof this.config.keepaliveGracePeriod)throw Error("keepaliveGracePeriod  must be specified and numeric if dropConnectionOnKeepaliveTimeout is true.");this._gracePeriodTimerHandler=this.handleGracePeriodTimer.bind(this)}}else if(this.config.keepalive&&this.config.useNativeKeepalive){if(!("setKeepAlive"in this.socket))throw Error("Unable to use native keepalive: unsupported by this version of Node.");this.socket.setKeepAlive(!0,this.config.keepaliveInterval)}}function validateReceivedCloseReason(e){return 1e3>e?!1:e>=1e3&&2999>=e?-1!==[1e3,1001,1002,1003,1007,1008,1009,1010,1011].indexOf(e):e>=3e3&&3999>=e?!0:e>=4e3&&4999>=e?!0:e>=5e3?!1:void 0}var crypto=require("crypto"),util=require("util"),EventEmitter=require("events").EventEmitter,WebSocketFrame=require("./WebSocketFrame"),BufferList=require("../vendor/FastBufferList"),Constants=require("./Constants"),Validation=require("./Validation").Validation;const STATE_OPEN="open",STATE_CLOSING="closing",STATE_CLOSED="closed";WebSocketConnection.CLOSE_REASON_NORMAL=1e3,WebSocketConnection.CLOSE_REASON_GOING_AWAY=1001,WebSocketConnection.CLOSE_REASON_PROTOCOL_ERROR=1002,WebSocketConnection.CLOSE_REASON_UNPROCESSABLE_INPUT=1003,WebSocketConnection.CLOSE_REASON_RESERVED=1004,WebSocketConnection.CLOSE_REASON_NOT_PROVIDED=1005,WebSocketConnection.CLOSE_REASON_ABNORMAL=1006,WebSocketConnection.CLOSE_REASON_INVALID_DATA=1007,WebSocketConnection.CLOSE_REASON_POLICY_VIOLATION=1008,WebSocketConnection.CLOSE_REASON_MESSAGE_TOO_BIG=1009,WebSocketConnection.CLOSE_REASON_EXTENSION_REQUIRED=1010,WebSocketConnection.CLOSE_REASON_INTERNAL_SERVER_ERROR=1011,WebSocketConnection.CLOSE_REASON_TLS_HANDSHAKE_FAILED=1015,WebSocketConnection.CLOSE_DESCRIPTIONS={1e3:"Normal connection closure",1001:"Remote peer is going away",1002:"Protocol error",1003:"Unprocessable input",1004:"Reserved",1005:"Reason not provided",1006:"Abnormal closure, no further detail available",1007:"Invalid data received",1008:"Policy violation",1009:"Message too big",1010:"Extension requested by client is required",1011:"Internal Server Error",1015:"TLS Handshake Failed"},util.inherits(WebSocketConnection,EventEmitter),WebSocketConnection.prototype.setKeepaliveTimer=function(){this.config.keepalive&&(this._keepaliveTimeoutID&&clearTimeout(this._keepaliveTimeoutID),this._gracePeriodTimeoutID&&clearTimeout(this._gracePeriodTimeoutID),this._keepaliveTimeoutID=setTimeout(this._keepaliveTimerHandler,this.config.keepaliveInterval))},WebSocketConnection.prototype.handleKeepaliveTimer=function(){this._keepaliveTimeoutID=null,this.ping(),this.config.dropConnectionOnKeepaliveTimeout?this.setGracePeriodTimer():this.setKeepaliveTimer()},WebSocketConnection.prototype.setGracePeriodTimer=function(){this._gracePeriodTimeoutID&&clearTimeout(this._gracePeriodTimeoutID),this._gracePeriodTimeoutID=setTimeout(this._gracePeriodTimerHandler,this.config.keepaliveGracePeriod)},WebSocketConnection.prototype.handleGracePeriodTimer=function(){this._gracePeriodTimeoutID=null,this.drop(WebSocketConnection.CLOSE_REASON_ABNORMAL,"Peer not responding.",!0)},WebSocketConnection.prototype.handleSocketData=function(e){for(this.setKeepaliveTimer(),this.bufferList.write(e);this.connected&&this.currentFrame.addData(this.bufferList);){if(this.currentFrame.protocolError)return this.drop(WebSocketConnection.CLOSE_REASON_PROTOCOL_ERROR,this.currentFrame.dropReason),void 0;if(this.currentFrame.frameTooLarge)return this.drop(WebSocketConnection.CLOSE_REASON_MESSAGE_TOO_BIG,this.currentFrame.dropReason),void 0;if(this.currentFrame.rsv1||this.currentFrame.rsv2||this.currentFrame.rsv3)return this.drop(WebSocketConnection.CLOSE_REASON_PROTOCOL_ERROR,"Unsupported usage of rsv bits without negotiated extension."),void 0;this.assembleFragments||this.emit("frame",this.currentFrame),this.processFrame(this.currentFrame),this.currentFrame=new WebSocketFrame(this.maskBytes,this.frameHeader,this.config)}},WebSocketConnection.prototype.handleSocketError=function(e){this.listeners("error").length>0&&this.emit("error",e),this.socket.end()},WebSocketConnection.prototype.handleSocketEnd=function(){this.socket.end(),this.frameQueue=null,this.outgoingFrameQueue=[],this.fragmentationSize=0,this.bufferList=null},WebSocketConnection.prototype.handleSocketClose=function(e){this.socketHadError=e,this.connected=!1,this.state=STATE_CLOSED,-1===this.closeReasonCode&&(this.closeReasonCode=WebSocketConnection.CLOSE_REASON_ABNORMAL,this.closeDescription="Connection dropped by remote peer."),this.closeEventEmitted||(this.closeEventEmitted=!0,this.emit("close",this.closeReasonCode,this.closeDescription)),this.clearCloseTimer(),this._keepaliveTimeoutID&&clearTimeout(this._keepaliveTimeoutID)},WebSocketConnection.prototype.handleSocketDrain=function(){this.outputPaused=!1,this.processOutgoingFrameQueue()},WebSocketConnection.prototype.close=function(){this.connected&&(this.closeReasonCode=WebSocketConnection.CLOSE_REASON_NORMAL,this.closeDescription=WebSocketConnection.CLOSE_DESCRIPTIONS[this.closeReasonCode],this.setCloseTimer(),this.sendCloseFrame(),this.state=STATE_CLOSING,this.connected=!1)},WebSocketConnection.prototype.drop=function(e,t,o){"number"!=typeof e&&(e=WebSocketConnection.CLOSE_REASON_PROTOCOL_ERROR),"string"!=typeof t&&(t=WebSocketConnection.CLOSE_DESCRIPTIONS[e]),this.closeReasonCode=e,this.closeDescription=t,this.outgoingFrameQueue=[],this.frameQueue=[],this.fragmentationSize=0,o||this.sendCloseFrame(e,t,!0),this.connected=!1,this.state=STATE_CLOSED,this.closeEventEmitted=!0,this.emit("close",e,t),this.socket.destroy()},WebSocketConnection.prototype.setCloseTimer=function(){this.clearCloseTimer(),this.waitingForCloseResponse=!0,this.closeTimer=setTimeout(this._closeTimerHandler,this.closeTimeout)},WebSocketConnection.prototype.clearCloseTimer=function(){this.closeTimer&&(clearTimeout(this.closeTimer),this.waitingForCloseResponse=!1,this.closeTimer=null)},WebSocketConnection.prototype.handleCloseTimer=function(){this.closeTimer=null,this.waitingForCloseResponse&&(this.waitingForCloseResponse=!1,this.socket.end())},WebSocketConnection.prototype.processFrame=function(e){if(0!==this.frameQueue.length&&e.opcode>0&&8>e.opcode)return this.drop(WebSocketConnection.CLOSE_REASON_PROTOCOL_ERROR,"Illegal frame opcode 0x"+e.opcode.toString(16)+" "+"received in middle of fragmented message."),void 0;switch(e.opcode){case 2:this.assembleFragments&&(e.fin?this.emit("message",{type:"binary",binaryData:e.binaryPayload}):(this.frameQueue.push(e),this.fragmentationSize=e.length));break;case 1:if(this.assembleFragments)if(e.fin){if(!Validation.isValidUTF8(e.binaryPayload))return this.drop(WebSocketConnection.CLOSE_REASON_INVALID_DATA,"Invalid UTF-8 Data Received"),void 0;this.emit("message",{type:"utf8",utf8Data:e.binaryPayload.toString("utf8")})}else this.frameQueue.push(e),this.fragmentationSize=e.length;break;case 0:if(this.assembleFragments){if(0===this.frameQueue.length)return this.drop(WebSocketConnection.CLOSE_REASON_PROTOCOL_ERROR,"Unexpected Continuation Frame"),void 0;if(this.fragmentationSize+=e.length,this.fragmentationSize>this.maxReceivedMessageSize)return this.drop(WebSocketConnection.CLOSE_REASON_MESSAGE_TOO_BIG,"Maximum message size exceeded."),void 0;if(this.frameQueue.push(e),e.fin){var t=0,o=new Buffer(this.fragmentationSize);switch(this.frameQueue.forEach(function(e){e.binaryPayload.copy(o,t),t+=e.binaryPayload.length}),this.frameQueue[0].opcode){case 2:this.emit("message",{type:"binary",binaryData:o});break;case 1:if(!Validation.isValidUTF8(o))return this.drop(WebSocketConnection.CLOSE_REASON_INVALID_DATA,"Invalid UTF-8 Data Received"),void 0;this.emit("message",{type:"utf8",utf8Data:o.toString("utf8")});break;default:return this.drop(WebSocketConnection.CLOSE_REASON_PROTOCOL_ERROR,"Unexpected first opcode in fragmentation sequence: 0x"+this.frameQueue[0].opcode.toString(16)),void 0}this.frameQueue=[],this.fragmentationSize=0}}break;case 9:this.pong(e.binaryPayload);break;case 10:break;case 8:if(this.waitingForCloseResponse)this.clearCloseTimer(),this.waitingForCloseResponse=!1,this.state=STATE_CLOSED,this.socket.end();else{this.state=STATE_CLOSING;var i;if(e.invalidCloseFrameLength?(this.closeReasonCode=1005,i=WebSocketConnection.CLOSE_REASON_PROTOCOL_ERROR):-1===e.closeStatus||validateReceivedCloseReason(e.closeStatus)?(this.closeReasonCode=e.closeStatus,i=WebSocketConnection.CLOSE_REASON_NORMAL):(this.closeReasonCode=e.closeStatus,i=WebSocketConnection.CLOSE_REASON_PROTOCOL_ERROR),e.binaryPayload.length>1){if(!Validation.isValidUTF8(e.binaryPayload))return this.drop(WebSocketConnection.CLOSE_REASON_INVALID_DATA,"Invalid UTF-8 Data Received"),void 0;this.closeDescription=e.binaryPayload.toString("utf8")}else this.closeDescription=WebSocketConnection.CLOSE_DESCRIPTIONS[this.closeReasonCode];this.sendCloseFrame(i),this.socket.end(),this.connected=!1}break;default:this.drop(WebSocketConnection.CLOSE_REASON_PROTOCOL_ERROR,"Unrecognized Opcode: 0x"+e.opcode.toString(16))}},WebSocketConnection.prototype.send=function(e,t){if(Buffer.isBuffer(e))this.sendBytes(e,t);else{if("function"!=typeof e.toString)throw Error("Data provided must either be a Node Buffer or implement toString()");this.sendUTF(e,t)}},WebSocketConnection.prototype.sendUTF=function(e,t){var o=new WebSocketFrame(this.maskBytes,this.frameHeader,this.config);o.opcode=1,o.binaryPayload=new Buffer(""+e,"utf8"),this.fragmentAndSend(o,t)},WebSocketConnection.prototype.sendBytes=function(e,t){if(!Buffer.isBuffer(e))throw Error("You must pass a Node Buffer object to WebSocketConnection.prototype.sendBytes()");var o=new WebSocketFrame(this.maskBytes,this.frameHeader,this.config);o.opcode=2,o.binaryPayload=e,this.fragmentAndSend(o,t)},WebSocketConnection.prototype.ping=function(e){var t=new WebSocketFrame(this.maskBytes,this.frameHeader,this.config);t.opcode=9,t.fin=!0,e&&(Buffer.isBuffer(e)||(e=new Buffer(""+e,"utf8")),e.length>125&&(e=e.slice(0,124)),t.binaryPayload=e),this.sendFrame(t)},WebSocketConnection.prototype.pong=function(e){var t=new WebSocketFrame(this.maskBytes,this.frameHeader,this.config);t.opcode=10,Buffer.isBuffer(e)&&e.length>125&&(e=e.slice(0,124)),t.binaryPayload=e,t.fin=!0,this.sendFrame(t)},WebSocketConnection.prototype.fragmentAndSend=function(e,t){if(e.opcode>7)throw Error("You cannot fragment control frames.");var o=this.config.fragmentationThreshold,i=e.binaryPayload.length;if(this.config.fragmentOutgoingMessages&&e.binaryPayload&&i>o)for(var n=Math.ceil(i/o),s=0,r=function(e){return e?("function"==typeof t&&(t(e),t=null),void 0):(++s,"function"==typeof t&&s===n&&t(),void 0)},a=1;n>=a;a++){var c=new WebSocketFrame(this.maskBytes,this.frameHeader,this.config);c.opcode=1===a?e.opcode:0,c.fin=a===n;var h=a===n?i-o*(a-1):o,l=o*(a-1);c.binaryPayload=e.binaryPayload.slice(l,l+h),this.sendFrame(c,r)}else e.fin=!0,this.sendFrame(e,t)},WebSocketConnection.prototype.sendCloseFrame=function(e,t,o){"number"!=typeof e&&(e=WebSocketConnection.CLOSE_REASON_NORMAL);var i=new WebSocketFrame(this.maskBytes,this.frameHeader,this.config);i.fin=!0,i.opcode=8,i.closeStatus=e,"string"==typeof t&&(i.binaryPayload=new Buffer(t,"utf8")),this.sendFrame(i,o)},WebSocketConnection.prototype.sendFrame=function(e,t,o){"function"==typeof t&&(o=t,t=!1),e.mask=this.maskOutgoingPackets;var i=e.toBuffer();this.outgoingFrameQueue.unshift([i,o]),this.bytesWaitingToFlush+=i.length,(!this.outputPaused||t)&&this.processOutgoingFrameQueue()},WebSocketConnection.prototype.processOutgoingFrameQueue=function(){if(!this.outputPaused&&this.outgoingFrameQueue.length>0){var e=this.outgoingFrameQueue.pop(),t=e[0],o=e[1];if(!this.connected&&"function"==typeof o)return o("Connection closed"),void 0;try{var i=this.socket.write(t,o)}catch(n){return"function"==typeof o&&o(""+n),this.listeners("error").length>0?this.emit("error","Error while writing to socket: "+(""+n)):Constants.DEBUG&&console.warn("Error while writing to socket: "+(""+n)),void 0}if(this.bytesWaitingToFlush-=t.length,!i)return this.outputPaused=!0,void 0;process.nextTick(this.outgoingFrameQueueHandler)}},module.exports=WebSocketConnection;