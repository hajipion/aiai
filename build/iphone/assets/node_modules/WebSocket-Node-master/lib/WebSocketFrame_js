function WebSocketFrame(e,t,i){this.maskBytes=e,this.frameHeader=t,this.config=i,this.maxReceivedFrameSize=i.maxReceivedFrameSize,this.protocolError=!1,this.frameTooLarge=!1,this.invalidCloseFrameLength=!1,this.parseState=DECODE_HEADER,this.closeStatus=-1}var ctio=require("../vendor/node-ctype/ctio-faster"),xor=require("./xor").xor;const DECODE_HEADER=1,WAITING_FOR_16_BIT_LENGTH=2,WAITING_FOR_64_BIT_LENGTH=3,WAITING_FOR_MASK_KEY=4,WAITING_FOR_PAYLOAD=5,COMPLETE=6;WebSocketFrame.prototype.addData=function(e){if(this.parseState===DECODE_HEADER&&e.length>=2){e.joinInto(this.frameHeader,0,0,2),e.advance(2);var t=this.frameHeader[0],i=this.frameHeader[1];if(this.fin=Boolean(128&t),this.rsv1=Boolean(64&t),this.rsv2=Boolean(32&t),this.rsv3=Boolean(16&t),this.mask=Boolean(128&i),this.opcode=15&t,this.length=127&i,this.opcode>=8){if(this.length>125)return this.protocolError=!0,this.dropReason="Illegal control frame longer than 125 bytes.",!0;if(!this.fin)return this.protocolError=!0,this.dropReason="Control frames must not be fragmented.",!0}this.parseState=126===this.length?WAITING_FOR_16_BIT_LENGTH:127===this.length?WAITING_FOR_64_BIT_LENGTH:WAITING_FOR_MASK_KEY}if(this.parseState===WAITING_FOR_16_BIT_LENGTH)e.length>=2&&(e.joinInto(this.frameHeader,2,0,2),e.advance(2),this.length=ctio.ruint16(this.frameHeader,"big",2),this.parseState=WAITING_FOR_MASK_KEY);else if(this.parseState===WAITING_FOR_64_BIT_LENGTH&&e.length>=8){e.joinInto(this.frameHeader,2,0,8),e.advance(8);var o=ctio.ruint64(this.frameHeader,"big",2);if(0!==o[0])return this.protocolError=!0,this.dropReason="Unsupported 64-bit length frame received",!0;this.length=o[1],this.parseState=WAITING_FOR_MASK_KEY}if(this.parseState===WAITING_FOR_MASK_KEY&&(this.mask?e.length>=4&&(e.joinInto(this.maskBytes,0,0,4),e.advance(4),this.parseState=WAITING_FOR_PAYLOAD):this.parseState=WAITING_FOR_PAYLOAD),this.parseState===WAITING_FOR_PAYLOAD){if(this.length>this.maxReceivedFrameSize)return this.frameTooLarge=!0,this.dropReason="Frame size of "+this.length.toString(10)+" bytes exceeds maximum accepted frame size",!0;if(0===this.length)return this.binaryPayload=new Buffer(0),this.parseState=COMPLETE,!0;if(e.length>=this.length)return this.binaryPayload=e.take(this.length),e.advance(this.length),this.mask&&xor(this.binaryPayload,this.maskBytes,0),8===this.opcode&&(1===this.length&&(this.binaryPayload=new Buffer(0),this.invalidCloseFrameLength=!0),this.length>=2&&(this.closeStatus=ctio.ruint16(this.binaryPayload,"big",0),this.binaryPayload=this.binaryPayload.slice(2))),this.parseState=COMPLETE,!0}return!1},WebSocketFrame.prototype.throwAwayPayload=function(e){return e.length>=this.length?(e.advance(this.length),this.parseState=COMPLETE,!0):!1},WebSocketFrame.prototype.toBuffer=function(e){var t,i,o,n=2,s=0,r=0;this.fin&&(s|=128),this.rsv1&&(s|=64),this.rsv2&&(s|=32),this.rsv3&&(s|=16),this.mask&&(r|=128),s|=15&this.opcode,8===this.opcode?(this.length=2,this.binaryPayload&&(this.length+=this.binaryPayload.length),i=new Buffer(this.length),ctio.wuint16(this.closeStatus,"big",i,0),this.length>2&&this.binaryPayload.copy(i,2)):this.binaryPayload?(i=this.binaryPayload,this.length=i.length):this.length=0,125>=this.length?r|=127&this.length:this.length>125&&65535>=this.length?(r|=126,n+=2):this.length>65535&&(r|=127,n+=8);var a=new Buffer(this.length+n+(this.mask?4:0));return a[0]=s,a[1]=r,o=2,this.length>125&&65535>=this.length?(ctio.wuint16(this.length,"big",a,o),o+=2):this.length>65535&&(ctio.wuint64([0,this.length],"big",a,o),o+=8),this.length>0&&(this.mask?(t=e?0:parseInt(4294967295*Math.random()),ctio.wuint32(t,"big",this.maskBytes,0),this.maskBytes.copy(a,o),o+=4,i.copy(a,o),xor(a.slice(o),this.maskBytes,0)):i.copy(a,o)),a},WebSocketFrame.prototype.toString=function(){return"Opcode: "+this.opcode+", fin: "+this.fin+", length: "+this.length+", hasPayload: "+Boolean(this.binaryPayload)+", masked: "+this.mask},module.exports=WebSocketFrame;