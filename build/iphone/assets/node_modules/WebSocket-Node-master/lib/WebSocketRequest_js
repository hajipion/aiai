function WebSocketRequest(e,t,o){this.socket=e,this.httpRequest=t,this.resource=t.url,this.remoteAddress=e.remoteAddress,this.serverConfig=o}for(var deprecation=require("./Deprecation"),crypto=require("crypto"),util=require("util"),url=require("url"),EventEmitter=require("events").EventEmitter,WebSocketConnection=require("./WebSocketConnection"),Constants=require("./Constants"),headerValueSplitRegExp=/,\s*/,headerParamSplitRegExp=/;\s*/,headerSanitizeRegExp=/[\r\n]/g,separators=["(",")","<",">","@",",",";",":","\\",'"',"/","[","]","?","=","{","}"," ",String.fromCharCode(9)],controlChars=[String.fromCharCode(127)],i=0;31>i;i++)controlChars.push(String.fromCharCode(i));var cookieNameValidateRegEx=/([\x00-\x20\x22\x28\x29\x2c\x2f\x3a-\x3f\x40\x5b-\x5e\x7b\x7d\x7f])/,cookieValueValidateRegEx=/[^\x21\x23-\x2b\x2d-\x3a\x3c-\x5b\x5d-\x7e]/,cookieValueDQuoteValidateRegEx=/^"[^"]*"$/,controlCharsAndSemicolonRegEx=/[\x00-\x20\x3b]/g,cookieSeparatorRegEx=/[;,] */,httpStatusDescriptions={100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",406:"Not Acceptable",407:"Proxy Authorization Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Long",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",426:"Upgrade Required",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported"};util.inherits(WebSocketRequest,EventEmitter),WebSocketRequest.prototype.readHandshake=function(){var e=this,t=this.httpRequest;if(this.resourceURL=url.parse(this.resource,!0),this.host=t.headers.host,!this.host)throw Error("Client must provide a Host header.");if(this.key=t.headers["sec-websocket-key"],!this.key)throw Error("Client must provide a value for Sec-WebSocket-Key.");if(this.webSocketVersion=parseInt(t.headers["sec-websocket-version"],10),Object.defineProperty(this,"websocketVersion",{get:function(){return deprecation.warn("websocketVersion"),this.webSocketVersion}}),!this.webSocketVersion||isNaN(this.webSocketVersion))throw Error("Client must provide a value for Sec-WebSocket-Version.");switch(this.webSocketVersion){case 8:case 13:break;default:var o=Error("Unsupported websocket client version: "+this.webSocketVersion+"Only versions 8 and 13 are supported.");throw o.httpCode=426,o.headers={"Sec-WebSocket-Version":"13"},o}13===this.webSocketVersion?this.origin=t.headers.origin:8===this.webSocketVersion&&(this.origin=t.headers["sec-websocket-origin"]);var i=t.headers["sec-websocket-protocol"];if(this.protocolFullCaseMap={},this.requestedProtocols=[],i){var r=i.split(headerValueSplitRegExp);r.forEach(function(t){var o=t.toLocaleLowerCase();e.requestedProtocols.push(o),e.protocolFullCaseMap[o]=t})}t.headers["x-forwarded-for"]&&(this.remoteAddress=t.headers["x-forwarded-for"].split(", ")[0]);var s=t.headers["sec-websocket-extensions"];this.requestedExtensions=this.parseExtensions(s);var n=t.headers.cookie;this.cookies=this.parseCookies(n)},WebSocketRequest.prototype.parseExtensions=function(e){return e&&0!==e.length?(extensions=e.toLocaleLowerCase().split(headerValueSplitRegExp),extensions.forEach(function(e,t,o){var i=e.split(headerParamSplitRegExp),r=i[0],s=i.slice(1);s.forEach(function(e,t,o){var i=e.split("="),r={name:i[0],value:i[1]};o.splice(t,1,r)});var n={name:r,params:s};o.splice(t,1,n)}),extensions):[]},WebSocketRequest.prototype.parseCookies=function(e){if(!e||"string"!=typeof e)return[];var t=[],o=e.split(cookieSeparatorRegEx);return o.forEach(function(e){var o=e.indexOf("=");if(-1===o)return t.push({name:e,value:null}),void 0;var i=e.substr(0,o).trim(),r=e.substr(++o,e.length).trim();'"'==r[0]&&(r=r.slice(1,-1)),t.push({name:i,value:decodeURIComponent(r)})}),t},WebSocketRequest.prototype.accept=function(e,t,o){if(e){var i=this.protocolFullCaseMap[e.toLocaleLowerCase()];i===void 0&&(i=e)}else i=e;this.protocolFullCaseMap=null;var r=new WebSocketConnection(this.socket,[],e,!1,this.serverConfig);r.webSocketVersion=this.webSocketVersion,Object.defineProperty(r,"websocketVersion",{get:function(){return deprecation.warn("websocketVersion"),this.webSocketVersion}}),r.remoteAddress=this.remoteAddress;var s=crypto.createHash("sha1");s.update(this.key+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11");var n=s.digest("base64"),a="HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: "+n+"\r\n";if(i){for(var c=0;i.length>c;c++){var h=i.charCodeAt(c),l=i.charAt(c);if(33>h||h>126||-1!==separators.indexOf(l))throw this.reject(500),Error("Illegal character '"+String.fromCharCode(l)+"' in subprotocol.")}if(-1===this.requestedProtocols.indexOf(e))throw this.reject(500),Error("Specified protocol was not requested by the client.");i=i.replace(headerSanitizeRegExp,""),a+="Sec-WebSocket-Protocol: "+i+"\r\n"}if(this.requestedProtocols=null,t&&(t=t.replace(headerSanitizeRegExp,""),13===this.webSocketVersion?a+="Origin: "+t+"\r\n":8===this.webSocketVersion&&(a+="Sec-WebSocket-Origin: "+t+"\r\n")),o){if(!Array.isArray(o))throw this.reject(500),Error("Value supplied for 'cookies' argument must be an array.");var u={};o.forEach(function(e){if(!e.name||!e.value)throw this.reject(500),Error("Each cookie to set must at least provide a 'name' and 'value'");if(e.name=e.name.replace(controlCharsAndSemicolonRegEx,""),e.value=e.value.replace(controlCharsAndSemicolonRegEx,""),u[e.name])throw this.reject(500),Error("You may not specify the same cookie name twice.");u[e.name]=!0;var t=e.name.match(cookieNameValidateRegEx);if(t)throw this.reject(500),Error("Illegal character "+t[0]+" in cookie name");if(t=e.value.match(cookieValueDQuoteValidateRegEx)?e.value.slice(1,-1).match(cookieValueValidateRegEx):e.value.match(cookieValueValidateRegEx))throw this.reject(500),Error("Illegal character "+t[0]+" in cookie value");var o=[e.name+"="+e.value];if(e.path){if(t=e.path.match(controlCharsAndSemicolonRegEx))throw this.reject(500),Error("Illegal character "+t[0]+" in cookie path");o.push("Path="+e.path)}if(e.domain){if("string"!=typeof e.domain)throw this.reject(500),Error("Domain must be specified and must be a string.");if(e.domain.toLowerCase(),t=e.domain.match(controlCharsAndSemicolonRegEx))throw this.reject(500),Error("Illegal character "+t[0]+" in cookie domain");o.push("Domain="+e.domain.toLowerCase())}if(e.expires){if(!(e.expires instanceof Date))throw this.reject(500),Error("Value supplied for cookie 'expires' must be a vaild date object");o.push("Expires="+e.expires.toGMTString())}if(e.maxage){var i=e.maxage;if("string"==typeof i&&(i=parseInt(i,10)),isNaN(i)||0>=i)throw this.reject(500),Error("Value supplied for cookie 'maxage' must be a non-zero number");i=Math.round(i),o.push("Max-Age="+i.toString(10))}if(e.secure){if("boolean"!=typeof e.secure)throw this.reject(500),Error("Value supplied for cookie 'secure' must be of type boolean");o.push("Secure")}if(e.httponly){if("boolean"!=typeof e.httponly)throw this.reject(500),Error("Value supplied for cookie 'httponly' must be of type boolean");o.push("HttpOnly")}a+="Set-Cookie: "+o.join(";")+"\r\n"}.bind(this))}a+="\r\n";try{this.socket.write(a,"ascii")}catch(d){Constants.DEBUG&&console.log("Error Writing to Socket: "+(""+d)),process.nextTick(function(){r.drop(1006,"TCP connection lost before handshake completed.",!0)})}return this.emit("requestAccepted",r),r},WebSocketRequest.prototype.reject=function(e,t,o){"number"!=typeof e&&(e=403);var i="HTTP/1.1 "+e+" "+httpStatusDescriptions[e]+"\r\n"+"Connection: close\r\n";if(t&&(t=t.replace(headerSanitizeRegExp,""),i+="X-WebSocket-Reject-Reason: "+t+"\r\n"),o)for(var r in o){var s=(""+o[r]).replace(headerSanitizeRegExp,""),n=r.replace(headerSanitizeRegExp,"");i+=n+": "+s+"\r\n"}i+="\r\n",this.socket.end(i,"ascii"),this.emit("requestRejected",this)},module.exports=WebSocketRequest;